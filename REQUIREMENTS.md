# F-Call 機能要件定義

## 概要

F-Callは待合室の呼び出しシステムです。本ドキュメントでは各機能の詳細な要件を定義します。

---

## 1. 発券機能

### 1.1 番号発行
- 患者が来院したら受付で番号を発行する
- 番号は当日内で連番（1, 2, 3...）
- 日付が変わると番号は1にリセット

### 1.2 優先度
| 優先度 | 説明 | 待ち列での位置 |
|--------|------|----------------|
| urgent（緊急） | 緊急患者 | 最前列 |
| appointment（予約） | 予約患者 | 緊急の後、一般の前 |
| normal（一般） | 一般患者 | 最後尾 |

---

## 2. 呼び出し機能

### 2.1 通常呼び出し
- スタッフが発券中リストから番号を選択
- 座席（診察室）を指定して呼び出し
- 呼び出された番号は待ち列から削除され、履歴に追加

### 2.2 呼び出し取り消し
**目的**: 誤って呼び出した番号を待ち列に戻す

| 項目 | 仕様 |
|------|------|
| 対象 | 現在呼び出し中の番号、または履歴にある番号 |
| 座席 | 空席に戻す |
| チケット | 発券中リストに戻す（優先度を保持） |
| 履歴 | 該当エントリを削除 |
| 結果 | 再度呼び出し可能になる |

**処理フロー**:
1. スタッフが履歴の「取消」ボタンをクリック
2. 確認ダイアログを表示
3. 座席を空席に戻す
4. チケットを発券中リストに戻す（元の優先度で適切な位置に挿入）
5. 履歴から該当エントリを削除
6. 成功メッセージを表示

---

## 3. スキップ機能

**目的**: 患者が不在などの理由で、その番号を欠番として処理する

| 項目 | 仕様 |
|------|------|
| 対象 | 発券済みで待ち列にある番号 |
| 待ち列 | 該当番号を削除 |
| スキップ履歴 | `skippedTickets`に記録（最大10件） |
| 発券履歴 | スキップフラグを追加 |
| 結果 | その番号は欠番となり、呼び出し対象外になる |

**処理フロー**:
1. スタッフが座席選択で「── スキップ ──」を選択
2. ボタンが「スキップ」に変わる
3. ボタンをクリックして確認ダイアログを表示
4. 待ち列から該当番号を削除
5. スキップ履歴に追加
6. 成功メッセージを表示

**注意**: スキップした番号は待ち列に戻らない（欠番扱い）

---

## 4. 診察完了機能

**目的**: 診察が終了した座席を空席に戻す

| 項目 | 仕様 |
|------|------|
| 対象 | 使用中（busy）の座席 |
| 座席 | 空席（available）に戻す |
| 履歴 | 変更なし（呼び出し記録は残る） |

---

## 5. スキップと取り消しの違い

| 機能 | スキップ | 取り消し |
|------|----------|----------|
| 目的 | 欠番処理（患者不在など） | 誤呼び出しの修正 |
| 対象状態 | 待ち列にある番号 | 呼び出し済みの番号 |
| 座席への影響 | なし | 空席に戻す |
| 待ち列への復帰 | しない（欠番） | する（再呼び出し可能） |
| 記録 | skippedTicketsに追加 | 履歴から削除 |

---

## 6. イベント一覧（Socket.io）

### クライアント → サーバー

| イベント名 | 説明 | パラメータ |
|------------|------|------------|
| `issueTicket` | 番号発行 | `{ priority }` |
| `callNumber` | 呼び出し | `{ number, seatId }` |
| `skipTicket` | スキップ | `{ number }` |
| `cancelCall` | 現在の呼び出しをキャンセル | なし |
| `cancelHistoryCall` | 履歴からキャンセル | `{ number, seatId, historyIndex }` |
| `completeSession` | 診察完了 | `{ seatId }` |
| `reset` | 全リセット | なし |

### サーバー → クライアント

| イベント名 | 説明 | パラメータ |
|------------|------|------------|
| `init` | 初期データ | 全状態 |
| `update` | 状態更新 | 全状態 |
| `callSuccess` | 呼び出し成功 | `{ number, seat, actualWaitTime }` |
| `skipSuccess` | スキップ成功 | `{ number }` |
| `skipFailed` | スキップ失敗 | `{ message }` |
| `cancelSuccess` | キャンセル成功 | `{ number, seat, message }` |
| `error` | エラー | `{ message }` |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-01 | 初版作成。スキップ・取り消し機能の要件を明確化 |

