<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VOICEVOXç›´æ¥ãƒ†ã‚¹ãƒˆ</title>
  <style>
    body {
      font-family: -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    #log {
      background: #000;
      color: #0f0;
      padding: 20px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
      margin-top: 20px;
      white-space: pre-wrap;
    }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #0ff; }
  </style>
</head>
<body>
  <h1>ğŸ”Š VOICEVOXç›´æ¥å†ç”Ÿãƒ†ã‚¹ãƒˆ</h1>
  
  <div>
    <button id="testBtn">VOICEVOXéŸ³å£°ãƒ†ã‚¹ãƒˆï¼ˆè‡ªå‹•ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼‰</button>
    <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
  </div>
  
  <div id="log"></div>

  <script>
    const logEl = document.getElementById('log');
    let audioUnlocked = false;

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    function clearLog() {
      logEl.innerHTML = '';
    }

    async function unlockAudio() {
      log('ğŸ”“ éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å‡¦ç†é–‹å§‹', 'info');
      
      const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
      silentAudio.volume = 0.01;
      
      try {
        await silentAudio.play();
        log('âœ… éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å®Œäº†', 'success');
        audioUnlocked = true;
      } catch (error) {
        log('âš ï¸ éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯å¤±æ•—: ' + error.message, 'error');
        log('âš ï¸ ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ç¶šè¡Œã—ã¾ã™', 'info');
        audioUnlocked = true; // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ•ãƒ©ã‚°ã¯ç«‹ã¦ã‚‹
      }
    }

    async function testVoicevox() {
      log('ğŸ“‹ VOICEVOXéŸ³å£°åˆæˆå‡¦ç†é–‹å§‹', 'info');
      
      const text = 'å—ä»˜ç•ªå·1ç•ªã®æ‚£è€…ã•ã¾ã€1ç•ªãƒ¦ãƒ‹ãƒƒãƒˆã¸ãŠè¶Šã—ãã ã•ã„';
      const speaker = 66; // ã‚‚ã¡å­ã•ã‚“ï¼ˆã‚»ã‚¯ã‚·ãƒ¼ï¼‰
      
      try {
        log(`ğŸ“¤ ã‚¹ãƒ†ãƒƒãƒ—1: éŸ³å£°ã‚¯ã‚¨ãƒªç”Ÿæˆ (speaker=${speaker})`, 'info');
        
        const queryUrl = `/api/voicevox/audio_query?text=${encodeURIComponent(text)}&speaker=${speaker}`;
        log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${queryUrl}`, 'info');
        
        const queryResponse = await fetch(queryUrl, {
          method: 'POST'
        });
        
        if (!queryResponse.ok) {
          throw new Error(`éŸ³å£°ã‚¯ã‚¨ãƒªå¤±æ•—: ${queryResponse.status} ${queryResponse.statusText}`);
        }
        
        const audioQuery = await queryResponse.json();
        log('âœ… éŸ³å£°ã‚¯ã‚¨ãƒªç”ŸæˆæˆåŠŸ', 'success');
        
        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š
        audioQuery.speedScale = 1.0;
        audioQuery.pitchScale = 0.0;
        audioQuery.intonationScale = 1.5;
        audioQuery.volumeScale = 1.2;
        audioQuery.prePhonemeLength = 0.1;
        audioQuery.postPhonemeLength = 0.1;
        audioQuery.outputSamplingRate = 48000;
        audioQuery.outputStereo = true;
        
        log('ğŸ“Š ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š:', 'info');
        log(`  - speedScale: ${audioQuery.speedScale}`, 'info');
        log(`  - pitchScale: ${audioQuery.pitchScale}`, 'info');
        log(`  - intonationScale: ${audioQuery.intonationScale}`, 'info');
        log(`  - volumeScale: ${audioQuery.volumeScale}`, 'info');
        log(`  - outputSamplingRate: ${audioQuery.outputSamplingRate}`, 'info');
        log(`  - outputStereo: ${audioQuery.outputStereo}`, 'info');
        
        log('ğŸ“¤ ã‚¹ãƒ†ãƒƒãƒ—2: éŸ³å£°åˆæˆ', 'info');
        
        const synthesisUrl = `/api/voicevox/synthesis?speaker=${speaker}&enable_interrogative_upspeak=true`;
        log(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL: ${synthesisUrl}`, 'info');
        
        const synthesisResponse = await fetch(synthesisUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'accept': 'audio/wav'
          },
          body: JSON.stringify(audioQuery)
        });
        
        if (!synthesisResponse.ok) {
          throw new Error(`éŸ³å£°åˆæˆå¤±æ•—: ${synthesisResponse.status} ${synthesisResponse.statusText}`);
        }
        
        const audioBlob = await synthesisResponse.blob();
        log(`âœ… éŸ³å£°åˆæˆæˆåŠŸ (ã‚µã‚¤ã‚º: ${(audioBlob.size / 1024).toFixed(2)} KB)`, 'success');
        
        log('ğŸ“¤ ã‚¹ãƒ†ãƒƒãƒ—3: éŸ³å£°å†ç”Ÿ', 'info');
        
        const audioUrl = URL.createObjectURL(audioBlob);
        const audio = new Audio(audioUrl);
        audio.volume = 1.0;
        
        audio.addEventListener('ended', () => {
          log('âœ… å†ç”Ÿå®Œäº†', 'success');
          URL.revokeObjectURL(audioUrl);
        });
        
        audio.addEventListener('error', (e) => {
          log('âŒ å†ç”Ÿã‚¨ãƒ©ãƒ¼: ' + (e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
          URL.revokeObjectURL(audioUrl);
        });
        
        await audio.play();
        log('ğŸ”Š å†ç”Ÿä¸­...', 'success');
        
      } catch (error) {
        log('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        log('ã‚¹ã‚¿ãƒƒã‚¯: ' + error.stack, 'error');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    window.addEventListener('load', () => {
      log('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'info');
      log('ğŸ’¡ ã€ŒVOICEVOXéŸ³å£°ãƒ†ã‚¹ãƒˆï¼ˆè‡ªå‹•ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'info');
      
      // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯â†’ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      document.getElementById('testBtn').addEventListener('click', async () => {
        log('=== VOICEVOXå†ç”Ÿãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆè‡ªå‹•ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼‰ ===', 'info');
        
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å†…ã§éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
        if (!audioUnlocked) {
          await unlockAudio();
        }
        
        // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ç¢ºèª
        if (!audioUnlocked) {
          log('âŒ éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          return;
        }
        
        // VOICEVOXéŸ³å£°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        await testVoicevox();
      });
    });
  </script>
</body>
</html>

